<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø–ª–∞—Ç–∞</title>
    <style>
        .payment-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .card-group {
            display: flex;
            gap: 10px;
        }

        .card-group input {
            flex: 1;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .success {
            color: #28a745;
            text-align: center;
            padding: 10px;
        }

        .loading {
            text-align: center;
            padding: 10px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ø–∞–ø–∞ —É—Å–ø–µ—Ö–∞ */
        .success-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .success-popup-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: popupShow 0.3s ease-out;
        }

        @keyframes popupShow {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .success-icon {
            font-size: 60px;
            color: #28a745;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
        }

        .success-message {
            font-size: 16px;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .return-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .return-btn:hover {
            background: #0056b3;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
<div class="payment-form">
    <h2>–û–ø–ª–∞—Ç–∞</h2>

    <form id="paymentForm" action="/payment-form/process" method="post">
        <input type="hidden" id="return_url" name="return_url" value="">

        <input type="hidden" id="callback_url" name="callback_url" value="">

        <!-- –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
        <div class="form-group">
            <label for="surname">–§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="surname" name="surname" placeholder="–ò–≤–∞–Ω–æ–≤" required>
        </div>

        <div class="form-group">
            <label for="nameUser">–ò–º—è</label>
            <input type="text" id="nameUser" name="nameUser" placeholder="–ò–≤–∞–Ω" required>
        </div>

        <div class="form-group">
            <label for="patronymic">–û—Ç—á–µ—Å—Ç–≤–æ</label>
            <input type="text" id="patronymic" name="patronymic" placeholder="–ò–≤–∞–Ω–æ–≤–∏—á" required>
        </div>

        <div class="form-group">
            <label for="amount">–°—É–º–º–∞</label>
            <input type="number" id="amount" name="amount" step="0.01" th:value="${amount}" readonly>
        </div>

        <div class="form-group">
            <label for="purpose">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</label>
            <input type="text" id="purpose" name="purpose" th:value="${purpose}" readonly>
        </div>

        <div class="form-group">
            <label for="cardNumber">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
            <input type="text" id="cardNumber" name="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19" required>
        </div>

        <div class="card-group">
            <div class="form-group">
                <label for="dateOfAction">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                <input type="text" id="dateOfAction" name="dateOfAction" placeholder="–ú–ú/–ì–ì" maxlength="5" required>
            </div>

            <div class="form-group">
                <label for="cvvCode">CVV</label>
                <input type="text" id="cvvCode" name="cvvCode" placeholder="000" maxlength="3" required>
            </div>
        </div>

        <div class="form-group">
            <label for="email">Email –¥–ª—è —á–µ–∫–∞</label>
            <input type="email" id="email" name="email" placeholder="your@email.com" required>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
            –û–ø–ª–∞—Ç–∏—Ç—å
        </button>
    </form>

    <div id="resultMessage" class="error-message"></div>
</div>

<!-- –ü–æ–ø–∞–ø —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ -->
<div id="successPopup" class="success-popup">
    <div class="success-popup-content">
        <div class="success-icon">‚úÖ</div>
        <div class="success-title">–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!</div>
        <div class="success-message">
            –í–∞—à –ø–ª–∞—Ç–µ–∂ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.<br>
            –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email.
        </div>
        <button class="return-btn" id="returnToSiteBtn">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç</button>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('paymentForm');
        const submitBtn = document.getElementById('submitBtn');
        const resultDiv = document.getElementById('resultMessage');
        const successPopup = document.getElementById('successPopup');
        const returnToSiteBtn = document.getElementById('returnToSiteBtn');
        const urlParams = new URLSearchParams(window.location.search);

        // üîß –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ü–û–õ–ï–ô –ò–ó URL –ü–ê–†–ê–ú–ï–¢–†–û–í
        console.log('üîç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã URL:', Object.fromEntries(urlParams.entries()));

        document.getElementById('amount').value = urlParams.get('amount') || '';
        document.getElementById('purpose').value = urlParams.get('product') || '';
        document.getElementById('email').value = urlParams.get('email') || '';
        document.getElementById('surname').value = urlParams.get('surname') || '';
        document.getElementById('nameUser').value = urlParams.get('nameUser') || '';

        const returnUrl = urlParams.get('return_url');
        if (returnUrl) {
            document.getElementById('return_url').value = returnUrl;
            console.log('‚úÖ Return URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', returnUrl);
        }

        console.log('üìä –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è:');
        console.log('amount:', document.getElementById('amount').value);
        console.log('purpose:', document.getElementById('purpose').value);
        console.log('email:', document.getElementById('email').value);

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
            value = value.substring(0, 16);
            value = value.replace(/(\d{4})/g, '$1 ').trim();
            e.target.value = value;
        });

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        document.getElementById('dateOfAction').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value.substring(0, 5);
            validateExpiryDate(e.target);
        });

        // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        function validateExpiryDate(input) {
            const value = input.value;
            input.style.borderColor = '';
            input.style.backgroundColor = '';

            if (!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(value)) {
                if (value.length === 5) {
                    input.style.borderColor = 'red';
                    input.title = '–§–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ú–ú/–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä: 12/25)';
                }
                return false;
            }

            const [monthStr, yearStr] = value.split('/');
            const month = parseInt(monthStr, 10);
            const year = 2000 + parseInt(yearStr, 10);
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;

            if (month < 1 || month > 12) {
                input.style.borderColor = 'red';
                input.title = '–ú–µ—Å—è—Ü –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 01 –¥–æ 12';
                return false;
            }

            if (year < currentYear || (year === currentYear && month < currentMonth)) {
                input.style.borderColor = 'red';
                input.title = `–ö–∞—Ä—Ç–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞. –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: ${currentMonth.toString().padStart(2, '0')}/${currentYear.toString().slice(2)}`;
                return false;
            }

            const maxFutureYear = currentYear + 10;
            if (year > maxFutureYear) {
                input.style.borderColor = 'orange';
                input.title = `–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–∏–π. –ú–∞–∫—Å–∏–º—É–º: ${maxFutureYear.toString().slice(2)}`;
                return false;
            }

            return true;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CVV
        document.getElementById('cvvCode').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value.substring(0, 3);
            validateCVVWithFeedback(e.target);
        });

        function validateCVVWithFeedback(input) {
            const value = input.value;
            input.style.borderColor = '';
            input.style.backgroundColor = '';

            if (value.length === 0) {
                input.title = '–í–≤–µ–¥–∏—Ç–µ CVV –∫–æ–¥ (3 —Ü–∏—Ñ—Ä—ã –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ –∫–∞—Ä—Ç—ã)';
                return;
            }

            if (value.length !== 3) {
                input.style.borderColor = 'red';
                input.style.backgroundColor = '#ffe6e6';
                input.title = `CVV –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 3 —Ü–∏—Ñ—Ä—ã (—Å–µ–π—á–∞—Å: ${value.length})`;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

                const formData = new FormData(this);
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:');
                for (let [key, value] of formData.entries()) {
                    console.log(key + ': ' + value);
                }

                const response = await fetch('/payment-form/process', {
                    method: 'POST',
                    body: formData
                });

                console.log('HTTP —Å—Ç–∞—Ç—É—Å:', response.status);
                const responseData = await response.json();
                console.log('–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseData);

                if (!response.ok) {
                    handleValidationErrors(responseData);
                } else {
                    handleSuccessResponse(responseData);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showErrorMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å';
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        function handleValidationErrors(errors) {
            console.log('–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', errors);
            clearAllErrors();

            for (const [fieldName, errorMessage] of Object.entries(errors)) {
                showFieldError(fieldName, errorMessage);
            }

            if (errors.error) {
                showErrorMessage(errors.error);
            }
        }

        // –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        function handleSuccessResponse(responseData) {
            console.log('–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:', responseData);

            if (responseData.status === 'SUCCESS') {
                showSuccessPopup();
                document.getElementById('paymentForm').reset();
                sendCallbackNotification(responseData);
            } else if (responseData.status === 'FAILED') {
                showErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ callback —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        async function sendCallbackNotification(paymentData) {
            try {
                const callbackUrl = paymentData.callback_url || getCallbackUrlFromPayment(paymentData.operationsId);

                if (callbackUrl) {
                    await fetch(callbackUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            payment_id: paymentData.operationsId,
                            status: 'SUCCESS',
                            amount: paymentData.amount,
                            timestamp: new Date().toISOString()
                        })
                    });
                    console.log('Callback —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ callback:', error);
            }
        }

        function getCallbackUrlFromPayment(operationId) {
            return document.getElementById('callback_url').value ||
                   new URLSearchParams(window.location.search).get('callback_url');
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç –º–µ—Ä—á–∞–Ω—Ç–∞
        function returnToMerchantSite() {
            console.log('–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–∞–π—Ç...');

            const urlParams = new URLSearchParams(window.location.search);
            let returnUrl = urlParams.get('return_url');

            if (!returnUrl) {
                returnUrl = "http://localhost:3000/demoshop.html";
            }

            console.log('Return URL:', returnUrl);

            const successUrl = new URL(returnUrl);
            const amount = document.getElementById('amount').value;
            const purpose = document.getElementById('purpose').value;

            successUrl.searchParams.append('payment_status', 'success');
            successUrl.searchParams.append('amount', amount);
            successUrl.searchParams.append('product', purpose);
            successUrl.searchParams.append('timestamp', Date.now());
            successUrl.searchParams.append('operation_id', 'OP-' + Date.now());

            const orderId = urlParams.get('order_id');
            if (orderId) {
                successUrl.searchParams.append('order_id', orderId);
            }

            console.log('–ü–æ–ª–Ω—ã–π URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞:', successUrl.toString());
            window.location.href = successUrl.toString();
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø–æ–ø–∞–ø–∞ —É—Å–ø–µ—Ö–∞
        function showSuccessPopup() {
            const successPopup = document.getElementById('successPopup');
            if (successPopup) {
                successPopup.style.display = 'flex';

                const returnBtn = document.getElementById('returnToSiteBtn');
                returnBtn.textContent = '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω';

                const countdownElement = document.createElement('div');
                countdownElement.style.marginTop = '15px';
                countdownElement.style.fontSize = '14px';
                countdownElement.style.color = '#666';

                const popupContent = successPopup.querySelector('.success-popup-content');
                popupContent.appendChild(countdownElement);

                let countdown = 5;
                countdownElement.textContent = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–∞–≥–∞–∑–∏–Ω —á–µ—Ä–µ–∑ ${countdown} —Å–µ–∫—É–Ω–¥...`;

                const countdownInterval = setInterval(() => {
                    countdown--;
                    countdownElement.textContent = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–∞–≥–∞–∑–∏–Ω —á–µ—Ä–µ–∑ ${countdown} —Å–µ–∫—É–Ω–¥...`;

                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        returnToMerchantSite();
                    }
                }, 1000);

                window.countdownInterval = countdownInterval;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç"
        returnToSiteBtn.addEventListener('click', function() {
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }
            returnToMerchantSite();
        });

        // –§—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        function showFieldError(fieldName, errorMessage) {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (!field) return;

            field.style.borderColor = '#dc3545';
            field.style.backgroundColor = '#f8d7da';

            let errorElement = field.parentNode.querySelector('.field-error');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'field-error';
                errorElement.style.color = '#dc3545';
                errorElement.style.fontSize = '12px';
                errorElement.style.marginTop = '5px';
                field.parentNode.appendChild(errorElement);
            }

            errorElement.textContent = errorMessage;
        }

        function clearAllErrors() {
            const fieldErrors = document.querySelectorAll('.field-error');
            fieldErrors.forEach(error => error.remove());

            const fields = document.querySelectorAll('input');
            fields.forEach(field => {
                field.style.borderColor = '';
                field.style.backgroundColor = '';
            });

            if (resultDiv) {
                resultDiv.style.display = 'none';
            }
        }

        function showErrorMessage(message) {
            if (resultDiv) {
                resultDiv.textContent = message;
                resultDiv.style.display = 'block';
                resultDiv.style.color = '#dc3545';
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.padding = '10px';
                resultDiv.style.borderRadius = '4px';
                resultDiv.style.marginTop = '15px';
            }
        }
    });
</script>

</body>
</html>